{% extends 'dashboard/base_dashboard.html' %}
{% load static formatting %}

{% block title %}Previsão de Receitas - Business{% endblock %}
{% block page_title %}Previsão de Receitas{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block dashboard_content %}
<div class="space-y-8">
  <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
    <div>
      <h2 class="text-3xl font-bold text-slate-100">Modelagem de receitas</h2>
      <p class="text-sm text-slate-400">
        Analise o histórico financeiro e visualize a projeção automática para os próximos {{ forecast_periods }} meses.
      </p>
    </div>
    <div class="flex flex-wrap gap-2">
      <a href="{% url 'business:financial_dashboard' %}"
         class="inline-flex items-center gap-2 rounded-lg border border-slate-700 px-4 py-2 text-sm font-semibold text-slate-200 transition-all duration-150 hover:border-slate-500 hover:text-white">
        Visão geral financeira
      </a>
      <a href="{% url 'business:revenue_create' %}"
         class="inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-green-500 to-blue-500 px-5 py-2 text-sm font-semibold text-white shadow-lg shadow-green-500/30 transition-all duration-150 hover:scale-105 hover:shadow-xl hover:shadow-green-500/40">
        Registrar nova receita
      </a>
    </div>
  </div>

  <form method="get"
        class="grid gap-4 rounded-2xl border border-slate-800 bg-slate-900/70 px-6 py-5 shadow-lg shadow-slate-950/40 md:grid-cols-[minmax(0,1fr)_auto_auto] md:items-end md:gap-6">
    <div class="flex flex-col gap-2">
      <label for="club" class="text-xs font-semibold uppercase tracking-widest text-slate-400">Filtrar por clube</label>
      <select id="club"
              name="club"
              class="w-full rounded-lg border border-slate-700 bg-slate-800 px-4 py-3 text-sm font-medium text-slate-200 transition-all duration-150 focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-500/40">
        <option value="">{% if selected_club %}Todos os clubes{% else %}Todos os clubes{% endif %}</option>
        {% for club in clubs %}
          <option value="{{ club.pk }}" {% if selected_club and club.pk == selected_club.pk %}selected{% endif %}>
            {{ club.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <button type="submit"
            class="inline-flex items-center justify-center rounded-lg bg-slate-200 px-5 py-3 text-sm font-semibold text-slate-900 transition-all duration-150 hover:bg-white">
      Aplicar filtro
    </button>
    {% if selected_club %}
      <a href="{% url 'business:revenue_forecast' %}"
         class="inline-flex items-center justify-center rounded-lg border border-slate-700 px-5 py-3 text-sm font-semibold text-slate-200 transition-all duration-150 hover:border-slate-500 hover:text-white">
        Limpar
      </a>
    {% endif %}
  </form>

  {% if not has_historical %}
    <div class="rounded-2xl border border-slate-700 bg-slate-900/60 p-6 shadow-lg shadow-slate-950/40">
      <div class="flex items-start gap-4">
        <span class="mt-1 inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-xl bg-slate-800 text-slate-400">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75A4.75 4.75 0 0 0 11.75 2h0A4.75 4.75 0 0 0 7 6.75v3.75M5 9h14l1 11H4l1-11Zm5 4v4m4-4v4" />
          </svg>
        </span>
        <div>
          <h3 class="text-lg font-semibold text-slate-100">Nenhuma receita cadastrada ainda</h3>
          <p class="mt-1 text-sm text-slate-400">
            Registre receitas mensais em <strong class="font-semibold text-slate-200">Business &gt; Receitas</strong> para habilitar o histórico e as projeções.
          </p>
        </div>
      </div>
    </div>
  {% endif %}

  {% if not forecast_result.has_sufficient_data %}
    <div class="rounded-2xl border border-amber-500/40 bg-amber-500/10 p-6 shadow-lg shadow-amber-900/30">
      <div class="flex items-start gap-4">
        <span class="mt-1 inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-xl bg-amber-500/20 text-amber-200">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01M4.93 19h14.14c1.54 0 2.5-1.67 1.73-3L13.73 4.99c-.77-1.33-2.69-1.33-3.46 0L3.2 16c-.77 1.33.19 3 1.73 3Z" />
          </svg>
        </span>
        <div>
          <h3 class="text-lg font-semibold text-amber-100">Dados insuficientes para treinar um modelo confiável</h3>
          <p class="mt-1 text-sm text-amber-200/80">
            Cadastre pelo menos {{ minimum_samples }} meses de receitas para que o algoritmo consiga gerar uma projeção consistente.
          </p>
          <p class="mt-3 text-xs text-amber-100/70">
            É possível visualizar o histórico existente, mas a curva de previsão aparecerá quando o volume mínimo de dados for alcançado.
          </p>
        </div>
      </div>
    </div>
  {% endif %}

  <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-4">
    <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-6 shadow-lg shadow-slate-950/40">
      <p class="text-xs font-semibold uppercase tracking-widest text-slate-400">Último mês registrado</p>
      <p class="mt-3 text-3xl font-bold text-slate-100 tabular-nums">
        {% if latest_historical_total %}
          R$ {{ latest_historical_total|currency_ptbr }}
        {% else %}
          —
        {% endif %}
      </p>
      <p class="mt-2 text-xs text-slate-500">Baseado na soma das categorias cadastradas.</p>
    </div>
    <div class="rounded-2xl border border-green-500/40 bg-green-500/10 p-6 shadow-lg shadow-green-900/30">
      <p class="text-xs font-semibold uppercase tracking-widest text-green-200">Próxima previsão</p>
      <p class="mt-3 text-3xl font-bold text-slate-100 tabular-nums">
        {% if next_prediction_total %}
          R$ {{ next_prediction_total|currency_ptbr }}
        {% else %}
          —
        {% endif %}
      </p>
      <p class="mt-2 text-xs text-green-100/70">
        {% if growth_percentage is not None %}
          Variação projetada de {{ growth_percentage|floatformat:1 }}%
        {% else %}
          Aguardando modelo treinado
        {% endif %}
      </p>
    </div>
    <div class="rounded-2xl border border-blue-500/40 bg-blue-500/10 p-6 shadow-lg shadow-blue-900/30">
      <p class="text-xs font-semibold uppercase tracking-widest text-blue-200">Média mensal histórica</p>
      <p class="mt-3 text-3xl font-bold text-slate-100 tabular-nums">
        {% if average_historical_total %}
          R$ {{ average_historical_total|currency_ptbr }}
        {% else %}
          —
        {% endif %}
      </p>
      <p class="mt-2 text-xs text-blue-100/70">Calculada a partir de todas as receitas registradas.</p>
    </div>
    <div class="rounded-2xl border border-purple-500/40 bg-purple-500/10 p-6 shadow-lg shadow-purple-900/30">
      <p class="text-xs font-semibold uppercase tracking-widest text-purple-200">Amostras e ajuste do modelo</p>
      <p class="mt-3 text-3xl font-bold text-slate-100">{{ forecast_result.trained_samples }}</p>
      <p class="mt-2 text-xs text-purple-100/70">
        {% if forecast_result.model_score is not None %}
          Ajuste R²: {{ forecast_result.model_score|floatformat:2 }}
        {% else %}
          Aguarde mais dados para avaliar a precisão.
        {% endif %}
      </p>
    </div>
  </div>

  <div class="grid gap-6 xl:grid-cols-3">
    <div class="xl:col-span-2 rounded-2xl border border-slate-800 bg-slate-900/70 p-6 shadow-lg shadow-slate-950/40">
      <div class="flex items-start justify-between">
        <div>
          <h3 class="text-xl font-semibold text-slate-100">Tendência dos próximos meses</h3>
          <p class="mt-1 text-xs text-slate-400">Serie histórica e curva de projeção</p>
        </div>
        <span class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold text-slate-300">
          Atualizado em tempo real
        </span>
      </div>
      <div class="mt-6">
        {% if chart_points %}
          <canvas id="revenueForecastChart" height="260"></canvas>
        {% else %}
          <div class="flex h-60 items-center justify-center rounded-xl border border-slate-800 bg-slate-900/60">
            <p class="text-sm text-slate-500">Nenhum dado disponível para o gráfico.</p>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-6 shadow-lg shadow-slate-950/40">
      <h3 class="text-xl font-semibold text-slate-100">Distribuição das categorias</h3>
      <p class="mt-1 text-xs text-slate-400">Participação média por tipo de receita</p>
      <div class="mt-6 space-y-4">
        {% for entry in distribution_entries %}
          <div>
            <div class="flex items-center justify-between text-xs font-semibold text-slate-300">
              <span>{{ entry.label }}</span>
              <span>{{ entry.percentage|floatformat:1 }}%</span>
            </div>
            <div class="mt-2 h-2 rounded-full bg-slate-800">
              <div class="h-2 rounded-full bg-gradient-to-r from-green-500 to-blue-500"
                   style="width: {{ entry.percentage }}%;"></div>
            </div>
          </div>
        {% empty %}
          <p class="text-sm text-slate-500">Nenhuma categoria disponível.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="rounded-2xl border border-slate-800 bg-slate-900/70 shadow-lg shadow-slate-950/40">
    <div class="flex items-start justify-between border-b border-slate-800 px-6 py-5">
      <div>
        <h3 class="text-xl font-semibold text-slate-100">Histórico e projeções</h3>
        <p class="mt-1 text-xs text-slate-400">Comparativo mês a mês com separação do que é observado e previsto.</p>
      </div>
    </div>
    {% if forecast_result.points %}
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-800">
          <thead class="bg-slate-900/80">
            <tr class="text-left text-xs font-semibold uppercase tracking-widest text-slate-400">
              <th scope="col" class="px-6 py-3">Período</th>
              <th scope="col" class="px-6 py-3 text-right">Total</th>
              <th scope="col" class="px-6 py-3 text-right">Bilheteria</th>
              <th scope="col" class="px-6 py-3 text-right">Patrocínio</th>
              <th scope="col" class="px-6 py-3 text-right">Direitos</th>
              <th scope="col" class="px-6 py-3 text-right">Merchandising</th>
              <th scope="col" class="px-6 py-3 text-center">Tipo</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800/70">
            {% for point in forecast_result.points %}
              <tr class="text-sm text-slate-200 {% if point.is_prediction %}bg-slate-900/30{% endif %}">
                <td class="px-6 py-4">
                  <span class="font-semibold text-slate-100">{{ point.label }}</span>
                </td>
                <td class="px-6 py-4 text-right tabular-nums">R$ {{ point.total|currency_ptbr }}</td>
                <td class="px-6 py-4 text-right text-slate-300 tabular-nums">R$ {{ point.ticketing|currency_ptbr }}</td>
                <td class="px-6 py-4 text-right text-slate-300 tabular-nums">R$ {{ point.sponsorship|currency_ptbr }}</td>
                <td class="px-6 py-4 text-right text-slate-300 tabular-nums">R$ {{ point.broadcasting|currency_ptbr }}</td>
                <td class="px-6 py-4 text-right text-slate-300 tabular-nums">R$ {{ point.merchandising|currency_ptbr }}</td>
                <td class="px-6 py-4 text-center">
                  {% if point.is_prediction %}
                    <span class="inline-flex items-center rounded-full border border-blue-500/40 bg-blue-500/10 px-3 py-1 text-xs font-semibold text-blue-100">
                      Previsto
                    </span>
                  {% else %}
                    <span class="inline-flex items-center rounded-full border border-green-500/40 bg-green-500/10 px-3 py-1 text-xs font-semibold text-green-100">
                      Observado
                    </span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="px-6 py-8">
        <p class="text-sm text-slate-500">Nenhum registro encontrado.</p>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    (function() {
      const canvas = document.getElementById('revenueForecastChart');
      if (!canvas) {
        return;
      }

      const rawData = JSON.parse('{{ chart_data_json|escapejs }}');
      if (!rawData.length) {
        return;
      }

      const labels = rawData.map(point => point.label);
      const historical = rawData.map(point => point.is_prediction ? null : point.value);
      const forecast = rawData.map(point => point.is_prediction ? point.value : null);

      const ctx = canvas.getContext('2d');
      // eslint-disable-next-line no-new
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Histórico',
              data: historical,
              borderColor: '#38bdf8',
              backgroundColor: 'rgba(56, 189, 248, 0.15)',
              borderWidth: 3,
              tension: 0.4,
              spanGaps: true,
              pointRadius: 4,
              pointBackgroundColor: '#0ea5e9',
              pointHoverRadius: 5,
            },
            {
              label: 'Previsão',
              data: forecast,
              borderColor: '#22c55e',
              backgroundColor: 'rgba(34, 197, 94, 0.15)',
              borderDash: [6, 6],
              borderWidth: 3,
              tension: 0.4,
              spanGaps: true,
              pointRadius: 4,
              pointBackgroundColor: '#22c55e',
              pointHoverRadius: 5,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'nearest',
            intersect: false,
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(71, 85, 105, 0.2)',
              },
              ticks: {
                color: '#cbd5f5',
                callback(value) {
                  return `R$ ${Number(value).toLocaleString('pt-BR', { minimumFractionDigits: 0 })}`;
                },
              },
            },
            x: {
              grid: {
                display: false,
              },
              ticks: {
                color: '#cbd5f5',
              },
            },
          },
          plugins: {
            legend: {
              labels: {
                color: '#e2e8f0',
              },
            },
            tooltip: {
              callbacks: {
                label(context) {
                  const value = context.parsed.y;
                  if (value === null || value === undefined) {
                    return 'Dados indisponíveis';
                  }
                  return `${context.dataset.label}: R$ ${Number(value).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                },
              },
            },
          },
        },
      });
    })();
  </script>
{% endblock %}
