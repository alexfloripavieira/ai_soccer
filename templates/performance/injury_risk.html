{% extends 'dashboard/base_dashboard.html' %}

{% block title %}Risco de Lesão - Performance{% endblock %}
{% block page_title %}Risco de Lesão{% endblock %}

{% block dashboard_content %}
<div class="space-y-6">
  <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
    <div>
      <h2 class="text-3xl font-bold text-slate-100">Monitoramento de risco</h2>
      <p class="text-sm text-slate-400">
        Previsões automáticas de probabilidade de lesão para os atletas do elenco com base nas cargas recentes de treino.
      </p>
    </div>
    <div class="flex flex-wrap gap-2">
      <a href="{% url 'performance:training_load_list' %}"
         class="inline-flex items-center gap-2 rounded-lg border border-slate-700 px-4 py-2 text-sm font-semibold text-slate-200 transition-all duration-150 hover:border-slate-500 hover:text-white">
        Registrar cargas
      </a>
      <a href="{% url 'performance:injury_record_list' %}"
         class="inline-flex items-center gap-2 rounded-lg border border-slate-700 px-4 py-2 text-sm font-semibold text-slate-200 transition-all duration-150 hover:border-slate-500 hover:text-white">
        Histórico de lesões
      </a>
    </div>
  </div>

  {% if insufficient_training_data %}
    <div class="rounded-2xl border border-amber-500/40 bg-amber-500/10 p-6 shadow-lg shadow-amber-900/30">
      <div class="flex flex-col gap-3">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-amber-500/20 text-amber-200">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01M12 3a9 9 0 1 1 0 18 9 9 0 0 1 0-18Z" />
            </svg>
          </span>
          <div>
            <p class="text-lg font-semibold text-amber-100">Dados insuficientes para treinar o modelo</p>
            <p class="text-sm text-amber-200/80">
              É necessário registrar pelo menos {{ minimum_samples }} amostras de cargas de treino com histórico de lesões associadas.
            </p>
          </div>
        </div>
        <p class="text-sm text-amber-200/70">
          Registre novas sessões em <strong class="font-semibold">Cargas de treino</strong> e mantenha os <strong class="font-semibold">registros de lesões</strong> atualizados para habilitar o modelo preditivo.
        </p>
      </div>
    </div>
  {% endif %}

  <div class="grid gap-6 lg:grid-cols-3">
    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-lg shadow-slate-950/40">
      <p class="text-sm font-semibold text-slate-400 uppercase tracking-wide">Atletas avaliados</p>
      <p class="mt-3 text-4xl font-bold text-slate-100">{{ total_evaluated }}</p>
      <p class="mt-2 text-xs text-slate-500">Atletas com dados recentes suficientes para cálculo de risco.</p>
    </div>
    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-lg shadow-slate-950/40">
      <p class="text-sm font-semibold text-slate-400 uppercase tracking-wide">Acurácia de validação</p>
      <p class="mt-3 text-4xl font-bold text-green-300">
        {% if validation_percentage is not None %}
          {{ validation_percentage|floatformat:2 }}%
        {% else %}
          —
        {% endif %}
      </p>
      <p class="mt-2 text-xs text-slate-500">Resultado da última validação interna do modelo.</p>
    </div>
    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-lg shadow-slate-950/40">
      <p class="text-sm font-semibold text-slate-400 uppercase tracking-wide">Amostras utilizadas</p>
      <p class="mt-3 text-4xl font-bold text-slate-100">{{ trained_samples }}</p>
      <p class="mt-2 text-xs text-slate-500">Sessões de treino consideradas no treinamento mais recente.</p>
    </div>
  </div>

  <div class="grid gap-6 lg:grid-cols-3">
    {% for entry in risk_distribution_entries %}
      <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-lg shadow-slate-950/40">
        <div class="flex items-center justify-between">
          <p class="text-sm font-semibold text-slate-300">{{ entry.label }}</p>
          <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Distribuição</span>
        </div>
        <p class="mt-3 text-3xl font-bold text-slate-100">{{ entry.count }}</p>
        {% if total_evaluated %}
          <div class="mt-4 h-2 rounded-full bg-slate-800">
            <div class="h-2 rounded-full bg-gradient-to-r from-green-500 to-blue-500"
                 style="width: {{ entry.percentage|floatformat:0 }}%;">
            </div>
          </div>
          <p class="mt-2 text-xs text-slate-500">
            {{ entry.count }} de {{ total_evaluated }} atletas ({{ entry.percentage|floatformat:0 }}%)
          </p>
        {% else %}
          <p class="mt-2 text-xs text-slate-500">Nenhum atleta avaliado até o momento.</p>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  {% if has_predictions %}
    <div class="grid gap-6 lg:grid-cols-3">
      <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-lg shadow-slate-950/40">
        <h3 class="text-lg font-semibold text-slate-100">Fatores de risco principais</h3>
        {% if highest_risk %}
          <p class="mt-2 text-sm text-slate-400">
            Destaque atual: <span class="font-semibold text-slate-100">{{ highest_risk.athlete.name }}</span> ({{ highest_risk.risk_label }})
          </p>
          <div class="mt-6">
            <canvas id="injury-risk-factors-chart" class="h-60 w-full"></canvas>
          </div>
          <div class="mt-6 space-y-2">
            {% for item in top_risks %}
              <div class="flex items-center justify-between rounded-xl border border-slate-800 bg-slate-900/70 px-4 py-3">
                <div>
                  <p class="text-sm font-semibold text-slate-100">{{ item.athlete.name }}</p>
                  <p class="text-xs text-slate-500">{{ item.risk_label }} • Confiança {{ item.confidence_percentage }}%</p>
                </div>
                <span class="text-sm font-semibold text-slate-100">{{ item.percentage }}%</span>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="mt-4 text-sm text-slate-400">Cadastre mais cargas de treino para visualizar os fatores de risco detalhados.</p>
        {% endif %}
      </div>
      <div class="lg:col-span-2 rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-lg shadow-slate-950/40">
        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
          <div>
            <h3 class="text-lg font-semibold text-slate-100">Atletas com maior risco</h3>
            <p class="text-sm text-slate-400">Priorize atenção e monitoramento para quem possui maior probabilidade de lesão.</p>
          </div>
          <div class="flex gap-2">
            <span class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold text-slate-300">
              Atualizado em tempo real
            </span>
          </div>
        </div>
        <div class="mt-6 overflow-hidden rounded-2xl border border-slate-800">
          <table class="min-w-full divide-y divide-slate-800/80">
            <thead class="bg-slate-900/80">
              <tr class="text-left text-xs font-semibold uppercase tracking-widest text-slate-400">
                <th scope="col" class="px-6 py-3">Atleta</th>
                <th scope="col" class="px-6 py-3">Probabilidade</th>
              <th scope="col" class="px-6 py-3">Confiança</th>
              <th scope="col" class="px-6 py-3">Categoria</th>
              <th scope="col" class="px-6 py-3">Freq. sessões (28d)</th>
              <th scope="col" class="px-6 py-3">Duração média</th>
              <th scope="col" class="px-6 py-3">Distância média</th>
              <th scope="col" class="px-6 py-3">A/C ratio</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800/80 bg-slate-900/40">
            {% for result in predictions %}
              <tr class="text-sm text-slate-200">
                <td class="px-6 py-4">
                  <div class="flex flex-col">
                    <span class="font-semibold text-slate-100">{{ result.athlete.name }}</span>
                    <span class="text-xs text-slate-500">{{ result.athlete.get_position_display }}</span>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <div class="flex items-center gap-3">
                    <div class="w-24 rounded-full bg-slate-800">
                      <div class="h-2 rounded-full bg-gradient-to-r from-amber-400 via-orange-500 to-red-500"
                           style="width: {{ result.percentage }}%;"></div>
                    </div>
                    <span class="text-sm font-semibold text-slate-100">{{ result.percentage }}%</span>
                  </div>
                </td>
                <td class="px-6 py-4 text-slate-300">{{ result.confidence_percentage }}%</td>
                <td class="px-6 py-4">
                  {% if result.risk_label == 'Alto risco' %}
                    <span class="inline-flex items-center rounded-full border border-red-500/40 bg-red-500/10 px-3 py-1 text-xs font-semibold text-red-200">
                      {{ result.risk_label }}
                    </span>
                  {% elif result.risk_label == 'Risco moderado' %}
                    <span class="inline-flex items-center rounded-full border border-amber-500/40 bg-amber-500/10 px-3 py-1 text-xs font-semibold text-amber-200">
                      {{ result.risk_label }}
                    </span>
                  {% else %}
                    <span class="inline-flex items-center rounded-full border border-green-500/40 bg-green-500/10 px-3 py-1 text-xs font-semibold text-green-200">
                      {{ result.risk_label }}
                    </span>
                  {% endif %}
                </td>
                <td class="px-6 py-4 text-slate-300">{{ result.session_frequency }}</td>
                <td class="px-6 py-4 text-slate-300">{{ result.average_duration|floatformat:0 }} min</td>
                <td class="px-6 py-4 text-slate-300">{{ result.average_distance|floatformat:2 }} km</td>
                <td class="px-6 py-4 text-slate-300">{{ result.acute_chronic_ratio|floatformat:2 }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    </div>
  {% else %}
    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6 shadow-lg shadow-slate-950/40">
      <div class="flex items-center gap-4">
        <span class="inline-flex h-12 w-12 items-center justify-center rounded-xl bg-slate-800 text-slate-400">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-3-3v6m9-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
        </span>
        <div>
          <p class="text-lg font-semibold text-slate-100">Ainda não há previsões</p>
          <p class="text-sm text-slate-400">
            Assim que houver histórico de cargas de treino recentes para os atletas, o modelo exibirá as probabilidades de lesão aqui.
          </p>
        </div>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
{% if has_predictions and highest_risk_chart %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  {{ highest_risk_chart|json_script:"injury-risk-chart-data" }}
  <script>
    (function() {
      const chartContainer = document.getElementById('injury-risk-factors-chart');
      const dataElement = document.getElementById('injury-risk-chart-data');
      if (!chartContainer || !dataElement || typeof Chart === 'undefined') {
        return;
      }
      const chartData = JSON.parse(dataElement.textContent);
      new Chart(chartContainer, {
        type: 'radar',
        data: {
          labels: chartData.labels,
          datasets: [
            {
              label: 'Índice de risco',
              data: chartData.values,
              borderColor: 'rgba(244, 114, 182, 0.8)',
              backgroundColor: 'rgba(244, 114, 182, 0.25)',
              pointBackgroundColor: 'rgba(244, 114, 182, 1)',
              pointBorderColor: 'rgba(244, 114, 182, 0.9)',
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            r: {
              beginAtZero: true,
              min: 0,
              max: 100,
              ticks: {
                stepSize: 20,
                color: '#94a3b8',
                backdropColor: 'rgba(15, 23, 42, 0.9)',
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.2)',
              },
              angleLines: {
                color: 'rgba(148, 163, 184, 0.2)',
              },
              pointLabels: {
                color: '#cbd5f5',
                font: {
                  size: 12,
                },
              },
            },
          },
          plugins: {
            legend: {
              display: false,
            },
          },
        },
      });
    })();
  </script>
{% endif %}
{% endblock %}
